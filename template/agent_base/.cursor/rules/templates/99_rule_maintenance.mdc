---
description: 対話型ルールブラッシュアップシステム
globs:
---
# ==========================================================
# 99_rule_maintenance.mdc - ルール保守システム（汎用）
# ==========================================================

path_reference: "agent_paths.mdc"

# ======== プロンプト（目的と使い方） ========
prompt_purpose: |
  生成済みエージェントのルール（00/01〜99）を対話でブラッシュアップし、必要に応じて新規ルール用のスケルトンも生成しながら、paths・トリガー・テンプレートの整合を保ったまま安全に反映します。

prompt_why_questions: |
  編集対象セクション・期待する変更内容・影響範囲・パス更新要否・検証手順を事前に整理し、破壊的変更や書式崩れを防ぐために質問します。

prompt_why_templates: |
  変更ログとパッチプランをテンプレート化することで、レビュー・差し戻し・再適用を高速に行い、履歴管理を容易にします。

prompt_principles: |
  - 既存ルールを尊重し、不要な再生成や書式崩れを避ける。
  - `templates.root_dir` / `root: "{{templates.root_dir}}/{{agent_name}}"` と paths の整合を常に確認する。
  - 変更理由・影響範囲・検証結果をFlow/agent_buildタスクリストと変更ログに記録する。
  - 対話で合意した内容のみ適用し、不確定な場合は保留メモを残す。
  - 00_master_rules.mdc／{domain}_paths.mdc／NN_{domain}_*.mdc を編集する際は、フロントマター（---／globs／path_reference）とタイトル帯・区切り構造を絶対に崩さない。
  - 新規ルールを追加するときは付属スケルトンの書式（タイトル帯・Phase区分・Questions/Templatesセクション）と命名規則を完全に踏襲する。
  - operation=add/edit でトリガーや保存パターンを変更・追加する場合は、00_master_rules.mdc の master_triggers と {domain}_paths.mdc の該当キーを必ず同期し、生合成を担保する。
  - 生成後のエージェントで 00_master_rules.mdc や {domain}_paths.mdc、フォルダ構成を変更したときは、本ルール内のチェックリスト/テンプレートに追跡タスクを追加し、以降の保守で確実に検知できるよう更新する。

# ======== トリガー定義 ========
trigger_phrases:
  rule_maintenance: "(ルール編集|ルール追加|ルール削除|ルール修正|ルール改定|ルール整備|ルール改修|rule maintenance|rule update|rule edit|rule add|rule improvement|ルールメンテ)"
  structure_update: "(フォルダ構成変更|フォルダ構成調整|パス更新|path更新|paths編集|パス構造変更|paths maintenance|path maintenance)"
trigger_registration_note: |
  master_triggers（00_master_rules.mdc）には上記 `rule_maintenance` と `structure_update` を必ず含め、生成後のエージェントでも 99_rule_maintenance.mdc が確実に呼び出される状態を維持すること。

# ======== ルール保守統合エージェント ========

system_capabilities:
  interactive_diagnosis: "対象ルールと変更箇所を対話で切り分け、影響範囲を明確化"
  format_guard: "必須セクション・区切り・命名規則をリアルタイムでチェック"
  diff_briefing: "修正前後の要約と追加すべき paths/template_reference を提案"
  trigger_alignment: "master_triggers とルール本文の整合を確認し、更新手順を提示"
  log_generation: "Flow/agent_build 向け変更ログとレビューチェックリストを自動生成"
  rollback_support: "差し戻し時の復旧ポイントとタスクリスト連携を案内"
  scaffold_new_rule: "operation=add 時に標準スケルトンと master_triggers 追記案を提示"

# ======== Phase 1: 計画フェーズ ========

phase_1_description: |
  編集対象ルール・変更理由・影響範囲・関連pathsを洗い出し、既存構造との衝突が無いか確認します。Flow/agent_buildタスクリストに作業項目を登録し、合意内容をログ化できれば完了です。

# ======== Phase 2: 適用フェーズ ========

phase_2_description: |
  合意済みの変更をパッチプランに落とし込み、必要な paths・master_triggers・テンプレート差分を提示します。Flow/agent_build の変更ログを生成し、レビューと検証計画が揃えば完了です。

# ======== 統合オプション質問 ========

rule_maintenance_questions:
  - key: "operation"
    prompt: "操作種別（edit|add。未指定時はedit扱い）："
    type: "text"
    required: true
    placeholder: "edit"
  - key: "target_rule"
    prompt: "対象ルールファイル（既存または作成予定。例: 02_domain_feature.mdc）："
    type: "text"
    required: true
    placeholder: "02_sample_feature.mdc"
  - key: "new_rule_number"
    prompt: "operation=add の場合: 追加したい番号（NN 2桁。例: 16）："
    type: "text"
    required: false
  - key: "new_rule_code"
    prompt: "operation=add の場合: 機能コード（英小文字+_）："
    type: "text"
    required: false
  - key: "new_rule_name"
    prompt: "operation=add の場合: 機能名（日本語）："
    type: "text"
    required: false
  - key: "change_scope"
    prompt: "変更したいセクション・行・トリガー内容："
    type: "multiline"
    required: true
    placeholder: "例：prompt_why_templates を最新要件へ更新"
  - key: "expected_outcome"
    prompt: "適用後にどうなっていてほしいか（成果物/挙動）："
    type: "multiline"
    required: true
  - key: "paths_update"
    prompt: "paths（{domain}_paths.mdc）を追加/修正する必要がありますか？（具体的なキー名と値）："
    type: "multiline"
    required: false
  - key: "domain_rules_ready"
    prompt: "対象ルールの保存先を定義する 01〜NN のエントリは確定済みですか？（yes/no と不足内容）："
    type: "multiline"
    required: true
  - key: "master_trigger_update"
    prompt: "00_master_rules.mdc の master_triggers を変更・追記しますか？（yes/no と内容）："
    type: "multiline"
    required: false
  - key: "tasklist_sync"
    prompt: "Flow/agent_build のタスクリストへ追記するチェック項目："
    type: "multiline"
    required: false
  - key: "verification_plan"
    prompt: "検証手順（レビュー・動作確認・必要なテストなど）："
    type: "multiline"
    required: true
  - key: "rollback_plan"
    prompt: "差し戻し時の復旧方法・連絡先："
    type: "multiline"
    required: false
  - key: "completion_plan"
    prompt: "スケルトンを埋める/既存ルールを更新する具体的な作業手順（誰が・いつ・どこまで）："
    type: "multiline"
    required: true
  - key: "reason"
    prompt: "変更理由（Why）と根拠資料："
    type: "multiline"
    required: true
  - key: "reviewer"
    prompt: "レビュー責任者（氏名/ロール）："
    type: "text"
    required: true
  - key: "due"
    prompt: "レビュー期限（YYYY-MM-DD）："
    type: "text"
    required: true

path_update_questions:
  - key: "target_paths_file"
    prompt: "更新対象の paths ファイル（例: music_paths.mdc）："
    type: "text"
    required: true
  - key: "current_root"
    prompt: "現在設定されている root（絶対パス）："
    type: "text"
    required: true
  - key: "new_root"
    prompt: "変更後の root（絶対パス）："
    type: "text"
    required: true
  - key: "structure_changes"
    prompt: "新たに追加・変更するディレクトリ/パターン（箇条書きで記載）："
    type: "multiline"
    required: true
  - key: "affected_rules"
    prompt: "影響を受けるルール番号または成果物："
    type: "multiline"
    required: true
  - key: "validation_status"
    prompt: "`python3 scripts/validate_rules.py` の実行結果（pass/fail とログパス）："
    type: "text"
    required: true
  - key: "followup_tasks"
    prompt: "必要なフォローアップ（タスクリストへの追加、レビュー担当など）："
    type: "multiline"
    required: false

rule_check_questions:
  - key: "target_rules"
    prompt: "チェック対象のルール範囲（例: 00/agent_paths/01-05など）："
    type: "text"
    required: true
  - key: "format_status"
    prompt: "フロントマター・globs・path_reference の整合性は保たれていますか？（yes/no + 懸念点）："
    type: "multiline"
    required: true
  - key: "delimiter_status"
    prompt: "タイトル帯・Phase帯・下位区切りの維持状況を記録してください："
    type: "multiline"
    required: true
  - key: "trigger_alignment"
    prompt: "master_triggers と対象ルールの trigger/steps は一致していますか？差分があれば記載してください："
    type: "multiline"
    required: true
  - key: "paths_alignment"
    prompt: "{domain}_paths.mdc に保存先・テンプレパターンが定義され、参照キーが一致していますか？不足があれば列挙："
    type: "multiline"
    required: true
  - key: "draft_vs_stock"
    prompt: "Flow/Stock/Archived の遷移で追加すべきチェック項目や不足ファイルはありますか？："
    type: "multiline"
    required: false
  - key: "warnings"
    prompt: "確認中に見つかった警告・要フォロー事項："
    type: "multiline"
    required: false
  - key: "actions"
    prompt: "次のアクション（必要な修正・担当・期限）："
    type: "multiline"
    required: true

# ======== ルール保守プロセス ========

rule_maintenance_steps:
  1_plan_alignment:
    name: "変更計画と整合確認"
    phases:
      - "対象ルールの現状を把握し、変更箇所と関連セクションを特定"
      - "paths・master_triggers・テンプレート参照先への影響を洗い出す"
      - "Flow/agent_build タスクリストへ作業・レビュー・検証項目を登録"
    quality_standards:
      - "変更理由と期待成果が明文化されている"
      - "paths 更新要否が判断済みである"
      - "レビュー責任者と期限が設定済みである"
      - "フロントマターと区切り構造を保持する前提で変更計画が立てられている"
      - "保存先を決める 01〜NN ルールの整備状況が確認されている"

  2_patch_design_and_log:
    name: "パッチ設計とログ生成"
    phases:
      - "変更前後の差分概要と必要な追記事項（paths/テンプレ/トリガー）を整理"
      - "Flow/agent_build/{{meta.year_month}}/{{meta.today}}_agent_creation_tasklist.md へ反映状況を記録"
      - "変更ログを作成し、検証・ロールバック手順と埋め込み作業計画を明記"
      - "operation=add の場合はスケルトン各セクションを埋める担当と期限を設定"
    integration_points:
      - "00_master_rules.mdc => master_triggers"
      - "agent_paths.mdc"
      - "Flow日付ディレクトリ（変更ログ配置）"
    quality_standards:
      - "新規・更新トリガーが 00_master_rules.mdc に追記・整形済みである"
      - "保存先/テンプレ参照が {domain}_paths.mdc に定義され、参照キーが一致している"

# ======== ルール保守ワークフロー ========

rule_maintenance_workflow:
  phase_1:
    - name: "情報収集"
      action: "call 99_rule_maintenance.mdc => rule_maintenance_questions"
      description: "変更計画に必要な情報を取得"
      mandatory: true
  phase_2:
    - name: "変更ログ作成"
      action: "create_markdown_file"
      description: "Flow/agent_build ログを生成し、レビュー準備を整える"
      mandatory: true

# ======== テンプレート ========

rule_skeleton_template: |
  # NOTE: operation=add の場合のみ使用してください
  ---
  description: {{meta.domain}} における {{function_name}} システム
  globs:
  alwaysApply: false
  ---
  # ==========================================================
  # {{nn}}_{{meta.domain}}_{{function_code}}.mdc - {{function_name}}システム
  # ==========================================================

  path_reference: "{{meta.domain}}_paths.mdc"

  # ======== プロンプト（目的と使い方） ========
  prompt_purpose: |
    本ルールは {{function_name}} の事実を整え、合意形成と次アクションを高速化します。出来事記録の標準を守り、再現可能性を高めます。

  prompt_why_questions: |
    欠落・曖昧・書式ブレを防ぐため、5W1HとType別DoD、詳細度（L1/L2/L3）を満たす質問を用意します。

  prompt_why_templates: |
    一貫したテンプレで列・見出し・用語を統一し、監査と自動化を容易にします。

  prompt_principles: |
    - 追記専用で記録し、過去行は不変とする。
    - 事実のみ記述し、Whyは当時の明言に限定する。
    - 出典必須、24時間以内に追記、Thread鎖を維持する。

  # ======== {{function_name}}システム統合エージェント ========

  system_capabilities:
    core_function: "{{function_name}}に関する中核処理"
    data_processing: "データ整形・検証・変換"
    workflow_management: "ワークフロー制御と自動化"
    quality_assurance: "必須項目検証とDoD確認"
    integration_support: "paths/他ルール連携"
    user_experience: "最小手順で正確に記録"

  # ======== Phase 1: 定義フェーズ ========

  phase_1_description: |
    目的・範囲・品質基準を合意し、入力要件を確認します。完成条件を明確にします。

  # ======== Phase 2: 作成フェーズ ========

  phase_2_description: |
    入力に基づきテンプレートを適用し、出力を生成します。最小の手戻りで確定させます。

  # ======== 統合オプション質問 ========

  {{function_code}}_questions:
    - key: "example_key"
      prompt: "例：必要情報を入力してください："
      type: "text"
      required: false

  # ======== {{function_name}}プロセス ========

  {{function_code}}_steps:
    1_prepare:
      name: "準備"
      phases:
        - "要件確認"
        - "出力定義"
        - "レビュー調整"
      quality_standards:
        - "必須入力が揃っている"
        - "pathsとの整合を確認"
        - "承認者が設定済み"

  # ======== {{function_name}}ワークフロー ========

  {{function_code}}_workflow:
    phase_1:
      - name: "ドラフト生成"
        action: "create_markdown_file"
        description: "Flowにドラフト作成"
        mandatory: true

  # ======== テンプレート ========

  {{function_code}}_template: |
    # {{function_name}} - {{meta.timestamp}}

    ## サマリー
    {{example_key}}

# ======== ログテンプレート ========

rule_maintenance_log_template: |
  # Rule Maintenance Log - {{target_rule}}
  **日時:** {{meta.timestamp}}
  **担当:** {{meta.user}}
  **操作種別:** {{operation}}

  ## 変更概要
  - 対象ルール: {{target_rule}}
  - 追加番号: {{new_rule_number}}
  - 追加コード: {{new_rule_code}}
  - 追加名称: {{new_rule_name}}
  - 変更箇所: {{change_scope}}
  - 期待する成果: {{expected_outcome}}
  - 変更理由: {{reason}}

  ## 影響範囲と対応
  - paths 更新: {{paths_update}}
  - master_triggers 更新: {{master_trigger_update}}
  - タスクリスト同期: {{tasklist_sync}}

  ## 検証とロールバック
  - 検証手順: {{verification_plan}}
  - ロールバック計画: {{rollback_plan}}

  ## 埋め込み／更新作業
  {{completion_plan}}

  ## レビュー情報
  - レビュワー: {{reviewer}}
  - レビュー期限: {{due}}

  ---
  - Flowログ保存先: {{patterns.rule_maintenance_log}}

rule_check_report_template: |
  # Rule Structure Check Report - {{target_rules}}
  **日時:** {{meta.timestamp}}
  **担当:** {{meta.user}}

  ## 対象範囲
  - ルール: {{target_rules}}

  ## フォーマット確認
  - フロントマター/グロブ/パス参照: {{format_status}}
  - タイトル帯・区切り: {{delimiter_status}}

  ## 整合性チェック
  - master_triggers との整合: {{trigger_alignment}}
  - paths 定義との整合: {{paths_alignment}}
  - Flow/Stock/Archived の運用メモ: {{draft_vs_stock}}

  ## 所見・警告
  {{warnings}}

  ## 必要なアクション
  {{actions}}

  ---
  - レポート保存先: {{patterns.rule_check_log}}

path_update_report: |
  # Path Update Report - {{target_paths_file}}
  **日時:** {{meta.timestamp}}
  **担当:** {{meta.user}}

  ## 変更概要
  - 現在の root: {{current_root}}
  - 新しい root: {{new_root}}

  ## 追加・変更ディレクトリ
  {{structure_changes}}

  ## 影響を受けるルール/成果物
  {{affected_rules}}

  ## バリデーション結果
  {{validation_status}}

  ## 追跡タスク
  {{followup_tasks}}

  ---
  - レポート保存先: {{patterns.rule_check_log}}

  # ======== エラーハンドリング ========

  error_handling:
    generic_error:
      message: "エラーが発生しました。入力内容とpaths設定を確認してください。"
      recovery_actions:
        - "入力値を再確認"
        - "pathsのキーを更新"

  # ======== 設定 ========

  {{function_code}}_settings:
    sample_setting: "value"

  # ======== 統合ポイント ========

  integration_points:
    sample_system:
      trigger: "更新時"
      action: "通知する"

  # ======== 品質保証 ========

  quality_assurance:
    mandatory_checks:
      - "必須入力が埋まっている"
      - "命名規則が遵守されている"

  # ======== 成功メトリクス ========

  success_metrics:
    - "レビュー差戻し率 < 10%"
    - "適用後の修正回数 < 1回/ルール"

# ======== エラーハンドリング ========

error_handling:
  invalid_nn:
    message: "NNが規定外です。01〜99の2桁で指定してください。"
    recovery_actions:
      - "番号リストを確認"
      - "既存ルールと重複がないか照合"
  missing_reason:
    message: "変更理由が入力されていません。Whyを必ず記録してください。"
    recovery_actions:
      - "reasonフィールドを追記"
      - "背景情報を添付"
  missing_change_scope:
    message: "変更箇所が未指定です。セクションやトリガーを明記してください。"
    recovery_actions:
      - "対象セクション名・行番号を追記"
      - "変更しない箇所は '変更なし' と明示"
  incomplete_verification:
    message: "検証手順が不足しています。レビューや動作確認方法を記載してください。"
    recovery_actions:
      - "verification_plan にレビュー・動作確認・テストの詳細を追記"
      - "必要であれば Flow/agent_build のタスクリストへ検証項目を追加"
  missing_add_metadata:
    message: "operation=add では new_rule_number/new_rule_code/new_rule_name を入力してください。"
    recovery_actions:
      - "各項目を追記し、番号重複が無いか確認"
      - "必要であれば AGENTS.md に沿って01〜89の命名規則を再確認"

# ======== 設定 ========

rule_maintenance_settings:
  log_path: "{{patterns.rule_maintenance_log}}"
  tasklist_path: "Flow/agent_build/{{meta.year_month}}/{{meta.today}}_agent_creation_tasklist.md"
  default_reviewer: "エージェント責任者"
  approval_required: true
  rule_check_log_path: "{{patterns.rule_check_log}}"

# ======== 統合ポイント ========

integration_points:
  master_rules:
    trigger: "トリガー追加"
    action: "master_triggers を更新"
  paths_file:
    trigger: "新規パターン登録"
    action: "agent_paths.mdc を編集"
  flow_agent_build_tasklist:
    trigger: "変更計画確定"
    action: "Flow/agent_build タスクリストに項目を追加"
  new_rule_skeleton:
    trigger: "operation=add"
    action: "{{patterns.rule_skeleton_out}} にスケルトンを生成"

# ======== 品質保証 ========

quality_assurance:
  mandatory_checks:
    - "変更理由・影響範囲・検証計画が記録されている"
    - "Flow/agent_build タスクリストとログが更新済み"
    - "paths・master_triggers の整合が確認されている"
    - "スケルトン/既存ルールの埋め込み計画が completion_plan に記録されている"

# ======== 成功メトリクス ========

success_metrics:
  - "レビュー差戻し率 < 5%"
  - "Flowタスクリスト更新から反映まで < 1営業日"
  - "paths/master_triggers の整合エラー 0 件"
  - "スケルトン埋め忘れ 0 件（タスクリスト完了率100%）"
