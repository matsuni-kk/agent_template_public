---
description: "Template Agent Master Control Rules - エージェント派生の統一基盤"
globs:
alwaysApply: true
---

# ==========================================================
# Agent Template - ドメイン特化エージェント生成フレームワーク
# ==========================================================

framework_overview:
  name: "Agent Template"
  description: "高品質な業務特化エージェントを生成するテンプレートベースフレームワーク。"
  focus_areas:
    - "業界標準準拠"
    - "実務即応性"
    - "手作り品質"


# =========================
# 設計思想
# =========================

design_principles:
  - id: "industry_standard_alignment"
    label: "業界標準準拠"
    description: "BABOK、AMA Marketing BOKなどの認知されたフレームワークに準拠する。"
  - id: "operational_readiness"
    label: "実務即応性"
    description: "現場で直ちに使える詳細なワークフローを提供する。"
  - id: "crafted_quality"
    label: "手作り品質"
    description: "専門知識に基づいた高品質テンプレートを維持する。"


# =========================
# エージェント作成ワークフロー
# =========================

agent_creation_tasks:
  description: "ヒアリングで蓄積した要件と合意事項を基にエージェント作成工程を管理する進捗タスクリスト。ユーザーと共有し、必要に応じて項目を追加・削除する。保存場所は日次Flow階層に統一（例: Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md）。要件定義ファイルは常に create_markdown_file で生成・更新し、以降の作業で参照・同期する。生成後のエージェントが独立運用する際も同一パス方針を維持する。"
  default_items:
    - id: "update_tasklist_file"
      detail: "作業開始直後に Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md を create_markdown_file で生成し、以降の工程管理と承認事項を記録する。保存場所は日次Flow配下に統一する。"
    - id: "create_requirements_file"
      detail: "タスクリスト生成と同時に {{patterns.flow_day_dir}}/draft_requirements.md（例: Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/draft_requirements.md）を create_markdown_file で作成し、ヒアリング結果と合意事項の記録先を確保する。外部タスク機能利用時も必須とし、以降の作業で常に参照・更新する。"
    - id: "sync_tasklist_with_requirements"
      detail: "各タスク完了時に Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md と {{patterns.draft_requirements}} の双方へ反映内容・判断・未決事項を追記し、ステータスと要件メモの差分を残さないよう同期する。"
    - id: "configure_root_path"
      detail: "`{domain}_paths.mdc` の `root: \"{{templates.root_dir}}/{{agent_name}}\"` を、実際にエージェントフォルダを配置するフルパス（例: `/Users/you/workspace/{{agent_info.domain}}_agent`）へ書き換える。タスクリストに設定したパスを記録し、# ---- 0. ルートディレクトリ コメントに同じ値を残す。"
    - id: "collect_requirements"
      detail: "ヒアリングで得た要件を {{patterns.draft_requirements}} に整理し、タスクリストと同期を取る。"
    - id: "confirm_initial_structure"
      detail: "Flow / Stock / Archived を初期構成として説明し、エージェント要件とフォルダ設計の双方について承認を得る。承認が得られない場合は後続工程へ進まない。"
    - id: "directory_alignment"
      detail: "ディレクトリ構成と {domain}_paths.mdc の整合を確認・調整する。"
    - id: "draft_domain_rules"
      detail: "01_{domain}_initialization.mdc を起点に番号順で NN_{domain}_*.mdc を整備し、質問・テンプレート・アクション・保存先の候補を確定させる。この段階では {domain}_paths.mdc / 00_master_rules.mdc に手を入れず、必要なキーとトリガーをメモしておく。"
    - id: "rule_customization"
      detail: "01番以降のルール整備を終えてから 00_master_rules.mdc と {domain}_paths.mdc を更新し、マスタートリガーとパス定義を反映する。"
    - id: "finalize_master_and_paths"
      detail: "すべての 01〜NN ルールで保存パターンとトリガーが確定した最終局面で {domain}_paths.mdc と 00_master_rules.mdc を一括で整備し、Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}} タスクリストに完了記録を残す。"
    - id: "cleanup_sample_rules"
      detail: "テンプレートコピー後に残ったサンプルルールファイル（01_sample_*.mdc など）を削除する。"
    - id: "post_completion_choice"
      detail: "ブラッシュアップ継続か、生成フォルダ単体のプライベートGit化かを確認する。"
agent_creation_workflow:
  overview:
    phase_sequence:
      - order: 1
        name: "Discovery"
        purpose: "ヒアリングと要件定義を実施し、合意内容をドキュメント化する。"
      - order: 2
        name: "Build"
        purpose: "スクリプトとテンプレートを用いてルール・パス・ドラフトを整備する。"
      - order: 3
        name: "Validation"
        purpose: "`scripts/validate_rules.py` で構文・パスの整合を確認し、エラーを修正したうえで結果をログ化する。"
      - order: 4
        name: "Release"
        purpose: "バリデーション結果を反映した状態でエージェントを運用に移行するか、追加改善を計画するかを決定する。"
    final_adjustment_note: "output/{{agent_info.domain}}_agent/.cursor/rules/ で最終調整を行い、Flow→Stock移行を準備する。Flow / Stock / Archived 以外の構成が必要な場合は、この段階でディレクトリと `{domain}_paths.mdc` の同期を確認し、合意した階層に揃える。"
  scenarios:
    - id: "scenario_standard"
      condition: "初回ヒアリングからエージェント生成までを一気通貫で進める標準フロー"
      steps:
        - order: 1
          name: "ヒアリング準備"
          tasks:
            - "作業開始直後に create_markdown_file を用いて Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md と {{patterns.draft_requirements}} を生成し、初回ヒアリング内容と承認事項の記録基盤を整える。"
            - "{{patterns.flow_day_dir}}/agent_discovery_brief.md を作成し、課題・対象ユーザー・期待成果を整理する。"
            - "既存資料があれば gather_existing_info を実行し、参照元リンクと取得日時を記録する。"
            - "関連ドメインの業界標準フレームワークを確認し、Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/framework_research.md を作成・記入する（出典URL・取得日時・要点・適用方針）。完了後、タスクリストに framework_research_done=true を記録する。未完了の場合は次工程へ進まない。"
        - order: 2
          name: "要件定義セッション"
      tasks:
        - "目的・KPI・成功条件を質問し記録する。"
        - "想定利用シナリオと成果物フォーマットを確認する。"
        - "利用予定データソース・外部システム・権限条件を確認する。"
        - "不確定事項を TODO: 形式で列挙し、合意時刻（例: {{meta.timestamp}}）を明記する。"
        - "ヒアリング内容を補完するため、業界標準フレームワークや最新トレンドを Web検索・文献調査で再確認し、出典と取得日時を {{patterns.draft_requirements}} に記録する。"
        - order: 3
          name: "仮設計ドキュメント化"
          tasks:
            - "{{patterns.draft_requirements}} に要件をまとめる。"
            - "必要に応じて {{patterns.draft_project_plan}} を作成する。"
            - "トリガー名称・テンプレート構造・主要ステップ案を整理し、コメントは {{patterns.flow_day_dir}} に残す。"
        - order: 4
          name: "ビルド準備と実行前チェック"
          tasks:
            - "目的・主要利用者・成果物・ドメイン用語が確定しているか確認する。"
            - "要件とフォルダ構成への承認が得られているか確認し、未承認の場合はこのステップで調整を完了させる。"
            - "scripts/enhanced_generate_agent.py を必ず使用して生成する（引数: --agent-name, --domain, --description）。"
            - "output/{agent_name}_agent/ が既存プロジェクトと競合しないことを確認する。"
            - "Flow / Stock / Archived を初期構成として案内し、この構成でドキュメント管理を進めてよいかユーザーに確認する。別構成案があればその要件を整理しタスクリストへ登録する。"
            - "フォルダ構成やエージェント要件について承認が得られない場合は、01_initialization で生成するディレクトリが最初のアクションになることを説明し承認を得る。"
        - order: 5
          name: "スケルトン生成"
          command:
            language: "bash"
            snippet: |
              scripts/enhanced_generate_agent.py --agent-name "Movie" --domain "movie" --description "映画調査・レビュー・サジェストエージェント"
        - order: 6
          name: "生成直後の必須作業"
          tasks:
            - "output/{agent_name}_agent/.cursor/rules/ に移動して作業を開始する。"
            - ".cursor/rules/agent_paths.mdc を {domain}_paths.mdc にリネームする。"
            - "template_paths.mdc を削除して参照衝突を防ぐ。"
            - "`templates.root_dir` および `root: \"{{templates.root_dir}}/{{agent_name}}\"` が実行環境の出力先を指すよう更新し、設定値をタスクリストに記録する。"
            - "要件定義で合意したフォルダ構成を {domain}_paths.mdc のコメントにメモし、保存先キーは 01〜ルールの確定後に本編集することを宣言する。"
            - "Stock 配下に `programs/{{project}}/documents/{{document_genre}}/` と `programs/{{project}}/images/{{image_category}}/` を初期生成（例: {{patterns.stock_documents_dir}} / {{patterns.stock_images_dir}}）し、エージェント要件に合わせてジャンルや画像カテゴリを柔軟に設定できる箱を整備する。"
            - "生成済みの Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md に root設定や確認事項を追記し、進捗管理を継続する。"
            - "作成済み {{patterns.draft_requirements}} にヒアリング内容と仮設計を逐次追記する。"
            - "01_{domain}_initialization.mdc から順に NN_{domain}_*.mdc を整備し、質問・テンプレート・アクション・出力パターンを確定させる。"
            - "02番以降のルールは初期化完了後に要件へ沿って順次設計・実装する計画を立て、タスクリストへ反映する。"
            - "02番以降で扱う成果物ごとに、保存パターンを 01〜NN ルールで確定させてから `{domain}_paths.mdc` の patterns セクションへ追加する。"
            - "01〜NN が揃った段階で 00_master_rules.mdc と {domain}_paths.mdc をまとめて更新し、説明・globs・master_triggers・パス定義を最終反映する。"
            - "99_rule_maintenance.mdc のログ/スケルトン/タスクリスト参照パターンを生成エージェントの Flow/Stock 構造に合わせて編集し、対応キーを {domain}_paths.mdc に追加する（旧パスの参照はここで除去する）。"
            - "master_triggers を含むマスタールール全体の整形・不要トリガー削除・番号整合を完了させてから次工程に進む。"
            - "97_flow_to_stock_rules.mdc / 98_flow_assist.mdc / 99_rule_maintenance.mdc を対象エージェントのパス・質問・運用プロセスで上書きする。"
            - "テンプレートに同梱されているサンプルルール（01_sample_*.mdc 等）が残っている場合は、このタイミングで削除する。"
            - "初期の Flow / Stock / Archived 構成で問題ないかユーザーに再確認し、調整が必要なら階層と `{domain}_paths.mdc` を更新し、タスクリストの進捗を完了にする。"
        - order: 7
          name: "バリデーション実行"
          tasks:
            - "output/{{agent_info.domain}}_agent/ に移動し、` scripts/validate_rules.py` を実行してエラー内容を確認する。"
            - "検証結果を {{patterns.rule_check_log}} に記録し、必要な修正があれば該当ルールを更新する。"
            - "修正後は再度 `scripts/validate_rules.py` を実行し、エラー解消状況をログに追記する。"
        - order: 8
          name: "改善タスク整理"
          tasks:
            - "検証結果とヒアリングメモを突き合わせ、{{patterns.backlog_root}} 等の管理票へ改善タスクを登録する。"
            - "重要な判断・未決事項を Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/{{meta.today}}_agent_creation_tasklist.md と {{patterns.draft_requirements}} の双方へ同期する。"
            - "必要に応じて 00_master_rules.mdc や NN_{domain}_{function}.mdc を更新し、変更理由と反映日をコメントに残す。"
        - order: 9
          name: "完了判定と運用移行"
          tasks:
            - "ドラフトが整った成果物を Flow から Stock へ移行するか判断し、97番台ルールを用いて確定版を保存する。"
            - "ユーザーと協議し、ブラッシュアップ継続か生成フォルダ単体のプライベートGit運用かを決定する。"
            - "選択した運用方針をタスクリストと {{patterns.draft_requirements}} に記録し、次サイクルで参照できるようにする。"
  task_tracking:
    description: "進捗を可視化するためのチェックリスト。ユーザーと共有しながら、Cursor などタスクリスト機能を持つ環境ではそちらを活用する。"
    items:
      - id: "root_path_configured"
        detail: "`templates.root_dir` と `root: \"{{templates.root_dir}}/{{agent_name}}\"` が実行環境に合わせて設定され、タスクリストに記録されているか。"
      - id: "tasklist_confirmation"
        detail: "Flow / Stock / Archived 初期構成の承認を得たか。"
      - id: "directory_setup"
        detail: "{domain}_paths.mdc とディレクトリ構成の整合を取ったか。"
      - id: "requirements_doc_ready"
        detail: "要件定義ファイルが create_markdown_file で生成され、最新のヒアリング内容が反映されているか。"
      - id: "tasklist_requirements_synced"
        detail: "各タスク更新時にタスクリストと {{patterns.draft_requirements}} の内容が同期され、差分が残っていないか。"
      - id: "rule_customization"
        detail: "00/01-99 のルールをドメイン仕様に合わせて更新したか。"
      - id: "feedback_actions"
        detail: "評価・改善タスク・完了後の運用方針確認まで実施したか。"
      - id: "validation_log_created"
        detail: "` scripts/validate_rules.py` を実行し、結果を {{patterns.rule_check_log}} に記録したか。"
      - id: "framework_research_logged"
        detail: "Flow/{{meta.year_month}}/{{meta.today}}/{{meta.agent_dir}}/framework_research.md を作成・記入し、タスクリストに framework_research_done=true を記録したか。未完了なら次工程へ進まない。"
  feedback_cycle:
    steps:
      - id: "validation_script"
        name: "ルールバリデーション"
        tasks:
      - "出力されたエージェントフォルダ（例: `output/{{agent_info.domain}}_agent/`）に移動し、` scripts/validate_rules.py` を実行して結果を確認する。"
          - "出力内容を {{patterns.rule_check_log}} に記録し、エラーが出た場合は該当ファイルを修正したうえで再実行する。"
      - id: "improvement_tasks"
        name: "改善タスク管理"
        tasks:
          - "{{patterns.backlog_root}} 等の管理票に改善タスクを登録し、完了条件と期限を明示する。"
          - "再発する課題は Flow の該当日付ディレクトリに原因分析メモを残す。"
      - id: "rule_update"
        name: "ルール更新と再配布"
        tasks:
          - "00_master_rules.mdc と該当する NN_{domain}_{function}.mdc を改訂し、変更理由と反映日を記録する。"
          - "Flow→Stock ルール（97番台）を用いて確定ドキュメントへ移行し、97/98/99番台の内容がエージェント固有の要件と整合するか確認する。"
      - id: "post_completion_decision"
        name: "完了後の運用方針確認"
        tasks:
          - "ユーザーに、再対話によるブラッシュアップ継続か `output/` 配下に生成されたエージェントフォルダ（例: `output/movie_agent/`）のみを用いたプライベートGitリポジトリ作成のどちらを希望するか確認する。"
          - "ブラッシュアップを選択した場合は対話を続け、反映内容を Flow 側ドラフトに落とし込む。"
          - "プライベートリポジトリを選択した場合は対象フォルダのみを新規リポジトリとして初期化し、リモートをプライベート設定で作成・push する。"
  master_trigger_registration:
    guidelines:
      - "トリガーは # ========================= / 1–N. Domain Rules (01–89) / ========================= 配下に追加する。"
      - "開始メッセージ・既存情報収集・質問呼び出し・成果物作成・完了メッセージの5ステップを最低構成とする。"
      - "Discoveryで確定した命名規則を反映し、pathは {{patterns.xxx}}、template_reference は NN_{domain}_{function}.mdc => セクション名 に統一する。"
    example:
      language: "yaml"
      snippet: |-
# -----
# 映画分析フェーズ (A-01. movie_analysis)
# -----

  - trigger: "(映画分析|映画調査|映画レビュー|movie analysis)"
    rule: ".cursor/rules/01_movie_analysis.mdc"
    description: "映画分析関連の処理を実行"

# =========================
# 生成されるエージェント構造（配置の統一）
# =========================
# =========================
# アーキテクチャ
# =========================
### ルール番号体系
# =========================
# 全体像クイックリファレンス
# =========================
### {機能名}

  - trigger: "({ドメイン固有トリガー}|{同義語}|{英語表記})"
    rule: ".cursor/rules/00_master_rules.mdc"
    description: "ドメイン固有トリガー関連の処理を実行"

#### 使用可能なactionの完全リスト
# =========================
# 実装必須ポイント
# =========================
# ======== プロンプト（目的と使い方） ========
# ======== {システム名}統合エージェント ========
# ======== Phase 1: {フェーズ名}フェーズ ========
# ======== Phase 2: {フェーズ名}フェーズ ========
# ======== {システム名}プロセス ========
# ==========================================================
# 01_{domain}_{function}.mdc - {機能名}システム
# ==========================================================
# ======== プロンプト（目的と使い方） ========
# ======== {機能名}システム統合エージェント ========
# ======== Phase 1: {フェーズ1名}フェーズ ========
# ======== Phase 2: {フェーズ2名}フェーズ ========
# ======== 統合オプション質問 ========
# ======== {機能名}プロセス ========
# ======== {機能名}ワークフロー ========
# ======== テンプレート ========
# {テンプレート名} - {{meta.timestamp}}
## セクション1
# ======== エラーハンドリング ========
# ======== 設定 ========
# ======== 統合ポイント ========
# ======== 品質保証 ========
# ======== 成功メトリクス ========
# =========================
# プロンプトセクション適用手順
# =========================
# =========================
# フレームワーク調査テンプレート
# =========================
# フレームワーク調査ログ - {{meta.timestamp}}
## 参照フレームワーク
## 要点（業務観点）
## 本エージェントへの適用方針
## 出典リスト（最低1件以上）
# =========================
# エージェント生成後の必須01〜ルール作成ワークフロー
# =========================
## A-01-01. Project Initialization Rules
### プロジェクト初期化

  - trigger: "({domain}プロジェクト開始|{domain}初期化|新規{domain}プロジェクト|プロジェクト開始)"
    rule: ".cursor/rules/01_{domain}_initialization.mdc"
    description: "プロジェクト開始関連の処理を実行"

  - trigger: "(要件分析|要件定義|requirements analysis)"
    rule: ".cursor/rules/02_requirements_analysis.mdc"
    description: "要件分析関連の処理を実行"

  - trigger: "(設計書作成|設計|design documentation)"
    rule: ".cursor/rules/03_design_documentation.mdc"
    description: "設計書作成関連の処理を実行"

  - trigger: "(進捗報告|progress report|状況報告)"
    rule: ".cursor/rules/04_progress_report.mdc"
    description: "進捗報告関連の処理を実行"

  - trigger: "(最終成果物|final deliverable|最終報告)"
    rule: ".cursor/rules/05_final_deliverable.mdc"
    description: "最終成果物関連の処理を実行"

# =========================
# エージェント品質検証フロー
# =========================
# =========================
# 注意事項
# =========================
# important-instruction-reminders
