---
description: Chrome拡張テスト・デバッグシステム
globs:
alwaysApply: false
---
# ==========================================================
# 07_chrome_extension_testing.mdc - テスト・デバッグ
# ==========================================================

path_reference: "chrome_extension_paths.mdc"

# ======== プロンプト（目的と使い方） ========
prompt_purpose: |
  Chrome拡張開発者がChrome開発者モードで拡張機能を読み込み、Popup UI、Background Service Worker、Content Scriptの動作確認とデバッグを体系的に実施します。

prompt_why_questions: |
  テスト対象の機能、確認すべき動作項目、想定されるエラーシナリオを収集することで、包括的なテスト計画を立て、バグの早期発見と品質保証を実現します。

prompt_why_templates: |
  Chrome開発者ツールの活用方法、ログ確認手順、デバッグチェックリストをテンプレート化することで、効率的なテストワークフローを提供し、Manifest V3特有の問題点を迅速に特定できます。

prompt_principles: |
  - Chrome開発者モードでの段階的テスト実施
  - Console、Network、Application タブの活用
  - 不足情報は「未記載」として明示
  - エラーログと再現手順の記録
  - 出典URL・取得日時を記録

# ======== テスト・デバッグシステム統合エージェント ========

system_capabilities:
  developer_mode_loading: "Chrome開発者モードで拡張機能を読み込み、manifest.json検証、リソース読み込み確認を実施"
  popup_testing: "Popup UIの表示、ボタン動作、Storage API連携、エラーハンドリングを検証"
  background_debugging: "Service Workerのコンソールログ、イベントリスナー動作、メッセージング機能を確認"
  content_script_verification: "Content ScriptのDOM操作、MutationObserver、ページイベント監視を検証"
  error_tracking: "Chrome Extensions APIのエラーログ、CSP違反、権限エラーを追跡・記録"
  performance_monitoring: "拡張機能のメモリ使用量、処理時間、リソース消費を監視"

# ======== Phase 1: テスト準備フェーズ ========

phase_1_description: |
  テスト対象の機能一覧、確認すべき動作項目、想定エラーシナリオを整理します。
  Chrome開発者モードで拡張機能を読み込み、manifest.jsonのバリデーションエラーがないことを確認します。
  テスト環境（Chromeバージョン、OS、テスト用URL等）を記録します。

# ======== Phase 2: テスト実行フェーズ ========

phase_2_description: |
  Popup UI、Background Service Worker、Content Scriptの順に動作確認を実施します。
  各コンポーネントのコンソールログを確認し、エラーや警告がないことを検証します。
  Storage API、Messaging API、Tabs APIなどのChrome API連携を確認します。
  発見したバグやエラーをFlow側のテストログに記録します。

# ======== 統合オプション質問 ========

testing_questions:
  - key: "test_targets"
    prompt: "テスト対象のコンポーネントを選択してください（カンマ区切り）:\n- manifest: manifest.jsonの検証\n- popup: Popup UIの動作確認\n- background: Background Service Workerの動作確認\n- content: Content Scriptの動作確認\n- storage: Storage APIの読み書き確認\n- messaging: コンポーネント間メッセージングの確認"
    type: "text"
    required: true
    placeholder: "例: manifest,popup,background,content"

  - key: "test_scenarios"
    prompt: "実施するテストシナリオを入力してください（カンマ区切り）:\n例: 初回インストール時の動作、設定保存・読み込み、タブ切り替え時の動作、エラーハンドリング"
    type: "text"
    required: false
    placeholder: "例: 初回インストール,設定保存,エラーハンドリング"

  - key: "test_urls"
    prompt: "Content Scriptのテストに使用するURLを入力してください（カンマ区切り、任意）："
    type: "text"
    required: false
    placeholder: "例: https://example.com, https://www.google.com"

  - key: "chrome_version"
    prompt: "テスト環境のChromeバージョンを入力してください："
    type: "text"
    required: false
    placeholder: "例: 120.0.6099.109"

  - key: "expected_issues"
    prompt: "想定される問題点や確認すべき懸念事項があれば入力してください（任意）："
    type: "multiline"
    required: false
    placeholder: "例: Content Scriptが特定サイトで動作しない、Storageの同期が遅い等"

# ======== テストプロセス ========

testing_steps:
  1_developer_mode_setup:
    name: "開発者モード設定"
    phases:
      - "Chromeを開き、chrome://extensions/ にアクセス"
      - "右上の「デベロッパーモード」を有効化"
      - "「パッケージ化されていない拡張機能を読み込む」をクリック"
      - "拡張機能のルートディレクトリ（manifest.jsonがある場所）を選択"
      - "エラーや警告が表示されないことを確認"
    quality_standards:
      - "manifest.json構文エラーがゼロ"
      - "必須アイコンファイルが存在"
      - "権限設定が適切"

  2_manifest_validation:
    name: "manifest.json検証"
    phases:
      - "chrome://extensions/ で拡張機能カードを確認"
      - "名前、バージョン、説明が正しく表示されているか確認"
      - "アイコンが正しく表示されているか確認"
      - "「エラー」ボタンがある場合はクリックしてエラー内容を確認"
    integration_points:
      - "02_chrome_extension_manifest.mdc で生成したmanifest.jsonを検証"

  3_popup_testing:
    name: "Popup UI動作確認"
    phases:
      - "ツールバーの拡張機能アイコンをクリックしてPopupを表示"
      - "右クリック→「検証」でDevToolsを開く"
      - "Consoleタブでエラーや警告がないか確認"
      - "ボタンクリック、フォーム入力など各機能を実際に操作"
      - "Storage APIの読み書きをApplicationタブで確認"
    automation_features:
      - "chrome.storage.sync.get() で保存されたデータを確認"
      - "ネットワークタブで外部リソース読み込みを監視"

  4_background_debugging:
    name: "Background Service Workerデバッグ"
    phases:
      - "chrome://extensions/ で拡張機能カードの「Service Worker」リンクをクリック"
      - "DevToolsのConsoleタブでログを確認"
      - "chrome.runtime.onInstalled、chrome.runtime.onMessageなどのイベントが正しく動作しているか確認"
      - "Alarms APIの動作確認（該当する場合）"
      - "メッセージング機能のテスト（PopupからBackgroundへメッセージ送信）"
    quality_standards:
      - "Service Worker起動時にエラーがない"
      - "イベントリスナーが正しく登録されている"
      - "非同期処理が正常に完了"

  5_content_script_testing:
    name: "Content Script動作確認"
    phases:
      - "テスト対象のURLをブラウザで開く"
      - "F12でDevToolsを開き、Consoleタブを確認"
      - "Content Scriptのログが表示されているか確認"
      - "DOM操作、スタイル変更が期待通りに実行されているか目視確認"
      - "MutationObserverが動作しているか確認（該当する場合）"
      - "BackgroundへのメッセージがApplicationタブで確認可能"
    integration_points:
      - "05_chrome_extension_content.mdc で実装したContent Scriptを検証"

  6_error_tracking:
    name: "エラー追跡・ログ記録"
    phases:
      - "chrome://extensions/ で「エラー」ボタンを確認"
      - "各コンポーネントのConsoleログからエラーメッセージを収集"
      - "CSP違反、権限エラー、API呼び出し失敗を特定"
      - "エラー内容、発生条件、再現手順をFlow側のテストログに記録"
    automation_features:
      - "エラーログをコピーしてMarkdownファイルに保存"

# ======== テストワークフロー ========

testing_workflow:
  phase_1:
    - name: "テスト準備"
      action: "call 07_chrome_extension_testing.mdc => testing_questions"
      description: "テスト対象とシナリオを確認"
      mandatory: true

  phase_2:
    - name: "開発者モード読み込み"
      action: "manual_step"
      description: "Chrome開発者モードで拡張機能を読み込む"
      mandatory: true

    - name: "各コンポーネントテスト実施"
      action: "manual_step"
      description: "Popup、Background、Content Scriptの動作確認"
      mandatory: true

    - name: "テストログ作成"
      action: "create_markdown_file"
      description: "Flow側にテスト結果とエラーログを保存"
      mandatory: true

# ======== テンプレート ========

testing_checklist_template: |
  # Chrome拡張テストチェックリスト - {{meta.timestamp}}

  ## テスト環境
  - **Chromeバージョン**: {{chrome_version}}
  - **OS**: {{os_version}}
  - **拡張機能バージョン**: {{extension_version}}
  - **テスト日時**: {{meta.timestamp}}

  ## テスト対象
  {{test_targets}}

  ## テストシナリオ
  {{test_scenarios}}

  ---

  ## 1. manifest.json検証
  - [ ] Chrome開発者モードで読み込み成功
  - [ ] 拡張機能名・バージョン・説明が正しく表示
  - [ ] アイコン（16x16, 48x48, 128x128）が表示
  - [ ] エラー・警告がゼロ

  **結果**:
  **備考**:

  ---

  ## 2. Popup UI動作確認
  - [ ] ツールバーアイコンクリックでPopup表示
  - [ ] Popup DevToolsでConsoleエラーがゼロ
  - [ ] ボタンクリック動作正常
  - [ ] フォーム入力・保存機能正常
  - [ ] Storage API読み書き正常（Applicationタブで確認）
  - [ ] メッセージ表示（成功/エラーフィードバック）正常

  **結果**:
  **スクリーンショット**:
  **備考**:

  ---

  ## 3. Background Service Worker動作確認
  - [ ] chrome://extensions/ でService Workerリンク表示
  - [ ] Service Worker DevToolsでConsoleエラーがゼロ
  - [ ] chrome.runtime.onInstalled イベント動作確認
  - [ ] chrome.runtime.onMessage イベント動作確認
  - [ ] Popup→Backgroundメッセージング成功
  - [ ] Alarms API動作確認（該当する場合）
  - [ ] 状態がStorage APIで永続化されている

  **結果**:
  **ログ抜粋**:
  **備考**:

  ---

  ## 4. Content Script動作確認
  {{#if test_urls}}
  ### テストURL: {{test_urls}}
  {{/if}}

  - [ ] Content Scriptがページに注入されている（Consoleログ確認）
  - [ ] DOM操作が正しく実行されている（目視確認）
  - [ ] CSSスタイルが適用されている（該当する場合）
  - [ ] MutationObserver動作確認（該当する場合）
  - [ ] イベントリスナー動作確認（該当する場合）
  - [ ] Content→Backgroundメッセージング成功

  **結果**:
  **スクリーンショット**:
  **備考**:

  ---

  ## 5. Storage API確認
  - [ ] chrome.storage.sync.set() で保存成功
  - [ ] chrome.storage.sync.get() で読み込み成功
  - [ ] Applicationタブ→Storage→Extension Storageでデータ確認
  - [ ] 異なるデバイス間での同期確認（該当する場合）

  **結果**:
  **備考**:

  ---

  ## 6. エラーハンドリング確認
  {{#if expected_issues}}
  ### 想定される問題点
  {{expected_issues}}
  {{/if}}

  - [ ] 要素が見つからない場合のエラーハンドリング
  - [ ] Storage API失敗時のフォールバック処理
  - [ ] メッセージング失敗時のエラー表示
  - [ ] 権限エラー時の適切なメッセージ表示

  **結果**:
  **備考**:

  ---

  ## 7. パフォーマンス確認
  - [ ] Popup表示速度 < 300ms
  - [ ] Content Script初期化速度 < 500ms
  - [ ] メモリ使用量が適切（chrome://extensions/ でメモリ確認）
  - [ ] CPU使用率が異常に高くない

  **結果**:
  **備考**:

  ---

  ## 発見した問題点
  | #  | コンポーネント | 問題内容 | 再現手順 | 重要度 | 対応状況 |
  |----|---------------|---------|---------|--------|---------|
  | 1  |               |         |         |        |         |
  | 2  |               |         |         |        |         |
  | 3  |               |         |         |        |         |

  ---

  ## 次のステップ
  - [ ] バグ修正
  - [ ] 再テスト実施
  - [ ] パッケージング準備
  - [ ] Chrome Web Store公開準備

  ---
  **保存先**: Flow/{{meta.year_month}}/{{meta.today}}/test_log_{{meta.today}}.md

debugging_guide_template: |
  # Chrome拡張デバッグガイド - {{meta.timestamp}}

  ## 1. 開発者モードで拡張機能を読み込む
  1. `chrome://extensions/` を開く
  2. 右上の「デベロッパーモード」をON
  3. 「パッケージ化されていない拡張機能を読み込む」をクリック
  4. manifest.jsonがあるディレクトリを選択

  ## 2. Popup UIのデバッグ
  1. ツールバーの拡張機能アイコンを右クリック
  2. 「検証」を選択してDevToolsを開く
  3. Consoleタブでエラーログを確認
  4. ElementsタブでDOM構造を確認
  5. Applicationタブ→Storageで保存データを確認

  ## 3. Background Service Workerのデバッグ
  1. `chrome://extensions/` で拡張機能カードを表示
  2. 「Service Worker」リンクをクリック
  3. DevToolsのConsoleタブでログを確認
  4. Sourcesタブでブレークポイントを設定してステップ実行

  ### Service Workerが停止している場合
  - Service Workerは非永続的で、アイドル時に自動停止します
  - Popup操作やメッセージ送信で自動的に再起動します
  - 停止中でもイベントリスナーは登録されています

  ## 4. Content Scriptのデバッグ
  1. テスト対象のWebページを開く
  2. F12でDevToolsを開く
  3. Consoleタブで `content.js` のログを確認
  4. Sourcesタブ→Content scriptsでコードを確認
  5. Elementsタブで注入されたCSSスタイルを確認

  ## 5. よくあるエラーと対処法

  ### エラー: "Uncaught (in promise) Error: Could not establish connection."
  - **原因**: BackgroundまたはContent Scriptが起動していない
  - **対処**: manifest.jsonの設定を確認、拡張機能を再読み込み

  ### エラー: "Refused to execute inline script because it violates CSP"
  - **原因**: インラインスクリプトがManifest V3で禁止されている
  - **対処**: すべてのスクリプトを外部JSファイルに移動

  ### エラー: "Storage quota exceeded"
  - **原因**: chrome.storage.sync の容量制限（100KB）を超過
  - **対処**: chrome.storage.local を使用（制限が緩い）

  ### エラー: "Extension context invalidated"
  - **原因**: 拡張機能が再読み込みされた
  - **対処**: ページをリロードしてContent Scriptを再注入

  ## 6. パフォーマンス監視
  - `chrome://extensions/` でメモリ使用量を確認
  - DevToolsのPerformanceタブでプロファイリング実施
  - Console APIでタイミング計測（console.time / console.timeEnd）

  ## 7. ログ出力のベストプラクティス
  ```javascript
  // 構造化ログ
  console.log('[Popup] Button clicked:', { action: 'toggle', timestamp: Date.now() });

  // エラーログ
  console.error('[Background] Failed to save settings:', error);

  // タイミング計測
  console.time('content-init');
  // 処理...
  console.timeEnd('content-init');
  ```

  ---
  **保存先**: Flow/{{meta.year_month}}/{{meta.today}}/debug_guide_{{meta.today}}.md

# ======== エラーハンドリング ========

error_handling:
  manifest_load_failure:
    message: "manifest.jsonの読み込みに失敗しました。"
    recovery_actions:
      - "JSON構文エラーを確認（カンマ、括弧の対応等）"
      - "必須フィールド（manifest_version, name, version）の存在確認"
      - "ファイルパスが正しいか確認"

  service_worker_crash:
    message: "Service Workerがクラッシュしました。"
    recovery_actions:
      - "chrome://extensions/ でエラーログを確認"
      - "無限ループや過剰なメモリ消費がないか確認"
      - "拡張機能を再読み込み"

# ======== 設定 ========

testing_settings:
  developer_mode_url: "chrome://extensions/"
  default_test_timeout: 5000
  screenshot_required: true

# ======== 統合ポイント ========

integration_points:
  validation:
    trigger: "テスト完了後"
    action: "call 06_chrome_extension_validation.mdc"

  packaging:
    trigger: "全テスト合格後"
    action: "call 08_chrome_extension_packaging.mdc"

# ======== 品質保証 ========

quality_assurance:
  mandatory_checks:
    - "manifest.json読み込み成功"
    - "全コンポーネントでConsoleエラーがゼロ"
    - "Storage API読み書き成功"
    - "メッセージング機能動作確認"
    - "テストログがFlow側に保存されている"

# ======== 成功メトリクス ========

success_metrics:
  - "manifest.json検証エラー = 0"
  - "Consoleエラー = 0"
  - "テストケース合格率 = 100%"
  - "デバッグ時間 < 2時間"
