---
description: "Chrome Extension Agent Master Control Rules - Chrome拡張機能開発支援エージェント"
globs:
alwaysApply: true
---
# 00_master_rules.mdc

# ==========================================================
# 00_chrome_extension.mdc - Chrome拡張開発マスタールール
# ==========================================================


path_reference: "chrome_extension_paths.mdc"
# =========================
# AI注意事項 - AIが確実に守るべき指示
# =========================
ai_instructions:
  - "すべてのルールは正確に実行し、独自の解釈で変更しないこと"
  - "execute_shellアクションのコマンドは一切変更せずそのまま実行すること"
  - "指定されたファイルパスやフォルダ構造を尊重し、勝手に構造を変更しないこと"
  - "失敗した場合でも代替手段を取らず、失敗を報告してユーザーの指示を仰ぐこと"
  - "セクションに `action: call [ファイル名].mdc => [プロセス名]` の指示があるときは、必ずそのファイルを読みに行き、詳細な手順・テンプレート・質問項目を確認すること"

master_triggers:
# =========================
  # A-01-XX. Chrome Extension Domain Specific Rules
# =========================

  ### プロジェクト初期化
  - trigger: "(Chrome拡張プロジェクト開始|Chrome拡張初期化|新規Chrome拡張プロジェクト|chrome extension init|chrome extension project)"
    priority: high
    description: "Chrome拡張プロジェクトの初期化とフォルダ構造作成"
    steps:
      - name: "start_message"
        action: "message"
        content: "**Chrome拡張プロジェクト初期化を開始します。**\n\nManifest V3準拠のプロジェクト構造を作成します。基本情報をお聞きしますので、お答えください。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_init_questions"
        action: "call 01_chrome_extension_initialization.mdc => project_init_questions"
      - name: "create_project_structure"
        action: "execute_shell"
        command: "mkdir -p src/css src/html src/js src/images src/libs build Flow/{{meta.year_month}}/{{meta.today}}/chrome_extension Stock/programs/{{project}}/documents Stock/programs/{{project}}/images Archived/keep"
      - name: "create_readme"
        action: "create_markdown_file"
        path: "README.md"
        template_reference: "01_chrome_extension_initialization.mdc => project_readme_template"
      - name: "create_project_plan"
        action: "create_markdown_file"
        path: "{{patterns.draft_project_plan}}"
        template_reference: "01_chrome_extension_initialization.mdc => project_plan_template"
      - name: "completion_message"
        action: "message"
        content: "**Chrome拡張プロジェクトの初期化が完了しました。**\n\nプロジェクト構造: README.md参照\n作業計画: {{patterns.draft_project_plan}}\n\n次のステップ: manifest.json設定（「Manifest設定」トリガー実行）"

  ### Manifest V3設定
  - trigger: "(Manifest設定|manifest作成|manifest.json生成|chrome manifest|manifest v3)"
    priority: high
    description: "Manifest V3準拠のmanifest.json生成"
    steps:
      - name: "start_manifest"
        action: "message"
        content: "**Manifest V3設定を開始します。**\n\n拡張機能の名称、権限、コンポーネント設定について詳しくお聞きします。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_manifest_questions"
        action: "call 02_chrome_extension_manifest.mdc => manifest_questions"
      - name: "create_manifest_draft"
        action: "create_markdown_file"
        path: "{{patterns.flow_day_dir}}/manifest_design_{{meta.today}}.md"
        template_reference: "02_chrome_extension_manifest.mdc => manifest_design_memo_template"
      - name: "manifest_completion"
        action: "message"
        content: "**Manifest設計メモを作成しました。**\n\n保存場所: {{patterns.flow_day_dir}}/manifest_design_{{meta.today}}.md\n\n次のステップ:\n1. manifest.jsonをルートディレクトリに配置\n2. 各コンポーネント実装開始（Popup/Background/Content）"

  ### Popup UI実装
  - trigger: "(Popup実装|popup作成|popup ui|chrome extension popup)"
    priority: high
    description: "Popup UI（ツールバーアイコンクリック時の表示）実装"
    steps:
      - name: "start_popup"
        action: "message"
        content: "**Popup UI実装を開始します。**\n\nツールバーアイコンをクリックした際に表示されるUIを作成します。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_popup_questions"
        action: "call 03_chrome_extension_popup.mdc => popup_questions"
      - name: "create_popup_files"
        action: "message"
        content: "Popup HTML/CSS/JSファイルを生成します..."
      - name: "popup_completion"
        action: "message"
        content: "**Popup UI実装が完了しました。**\n\nファイル:\n- src/html/popup.html\n- src/css/popup.css\n- src/js/popup.js\n\n次のステップ: Background Service Worker実装"

  ### Background Service Worker実装
  - trigger: "(Background実装|background作成|service worker|chrome extension background)"
    priority: high
    description: "Background Service Worker（バックグラウンド処理）実装"
    steps:
      - name: "start_background"
        action: "message"
        content: "**Background Service Worker実装を開始します。**\n\nManifest V3準拠のService Workerを作成します。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_background_questions"
        action: "call 04_chrome_extension_background.mdc => background_questions"
      - name: "create_background_file"
        action: "message"
        content: "background.jsを生成します..."
      - name: "background_completion"
        action: "message"
        content: "**Background Service Worker実装が完了しました。**\n\nファイル: src/js/background.js\n\n次のステップ: Content Script実装"

  ### Content Script実装
  - trigger: "(Content Script実装|content作成|content script|chrome extension content)"
    priority: high
    description: "Content Script（ページ操作）実装"
    steps:
      - name: "start_content"
        action: "message"
        content: "**Content Script実装を開始します。**\n\nWebページのDOM操作とイベント監視を行うスクリプトを作成します。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_content_questions"
        action: "call 05_chrome_extension_content.mdc => content_questions"
      - name: "create_content_files"
        action: "message"
        content: "content.js/content.cssを生成します..."
      - name: "content_completion"
        action: "message"
        content: "**Content Script実装が完了しました。**\n\nファイル:\n- src/js/content.js\n- src/css/content.css\n\n次のステップ: バリデーションチェック"

  ### バリデーションチェック
  - trigger: "(バリデーション|validation|Chrome拡張検証|manifest検証|chrome extension validate)"
    priority: high
    description: "Manifest V3準拠・セキュリティ・ファイル整合性の自動検証"
    steps:
      - name: "start_validation"
        action: "message"
        content: "**Chrome拡張バリデーションを開始します。**\n\nManifest V3準拠、権限、セキュリティ、ファイル整合性を検証します。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_validation_questions"
        action: "call 06_chrome_extension_validation.mdc => validation_questions"
      - name: "run_validation"
        action: "message"
        content: "バリデーション実行中..."
      - name: "create_validation_report"
        action: "create_markdown_file"
        path: "{{patterns.flow_day_dir}}/validation_log_{{meta.today}}.md"
        template_reference: "06_chrome_extension_validation.mdc => validation_report_template"
      - name: "validation_completion"
        action: "message"
        content: "**バリデーション完了しました。**\n\nレポート: {{patterns.flow_day_dir}}/validation_log_{{meta.today}}.md\n\nエラーがある場合は修正後、再度「バリデーション」トリガーを実行してください。\nエラーゼロになるまで繰り返してください。"

  ### テスト・デバッグ
  - trigger: "(Chrome拡張テスト|test|デバッグ|chrome extension test|chrome extension debug)"
    priority: medium
    description: "Chrome開発者モードでのテスト・デバッグ支援"
    steps:
      - name: "start_testing"
        action: "message"
        content: "**Chrome拡張テスト・デバッグを開始します。**\n\nChrome開発者モードで拡張機能を読み込み、動作確認を行います。"
      - name: "collect_existing_info"
        action: "gather_existing_info"
      - name: "ask_testing_questions"
        action: "call 07_chrome_extension_testing.mdc => testing_questions"
      - name: "create_testing_checklist"
        action: "create_markdown_file"
        path: "{{patterns.flow_day_dir}}/testing_checklist_{{meta.today}}.md"
        template_reference: "07_chrome_extension_testing.mdc => testing_checklist_template"
      - name: "testing_completion"
        action: "message"
        content: "**テストチェックリストを作成しました。**\n\n保存場所: {{patterns.flow_day_dir}}/testing_checklist_{{meta.today}}.md\n\n次のステップ: チェックリストに従ってテスト実施、エラーがあれば修正後に再バリデーション"

# =========================
# =========================
  # 98. Flow Assist (Interactive support)
# =========================
  - trigger: "(アイディア発散Template|Templateブレスト|ヒューリスティック思考Template)"
    priority: medium
    steps:
      - name: "prepare_flow_workspace"
        action: "execute_shell"
        command: "mkdir -p {{patterns.flow_day_dir}}"
        message: "本日分の Flow ワークスペースを準備します..."
      - name: "ask_brainstorm_questions"
        action: "call 98_flow_assist.mdc => brainstorm_questions"
        message: "アイデア発散セッションを開始します。テーマなどを教えてください。"
      - name: "wait_brainstorm_answers"
        action: "wait_for_all_answers"
      - name: "create_brainstorm_notes"
        action: "create_markdown_file"
        path: "{{patterns.brainstorm_notes_md}}"
        template_reference: "98_flow_assist.mdc => brainstorm_template"
        message: "アイデア発散ノートを作成しました: {{patterns.brainstorm_notes_md}}"
      - name: "notify_brainstorm_creation"
        action: "notify"
        message: "✅ アイデア発散ノートが {{patterns.brainstorm_notes_md}} に作成されました。"
# =========================
  # 99. Rule Maintenance & System Management
# =========================
  - trigger: "(ルールチェック|ルール構造チェック|ルール品質確認|RuleLint|ルール診断|ルール整合性確認|Template構造検証|rule lint|rule health check|rule audit)"
    priority: medium
    steps:
      - name: "perform_rule_lint"
        action: "call 99_rule_maintenance.mdc => rule_check_questions"
        message: "ルール整合性チェックとTemplate構造検証に必要な情報を確認します。"
      - name: "create_rule_check_report"
        action: "create_markdown_file"
        path: "{{patterns.rule_check_log}}"
        template_reference: "99_rule_maintenance.mdc => rule_check_report_template"
        message: "チェック結果レポートを {{patterns.rule_check_log}} に作成しました。"
      - name: "notify_rule_check_completion"
        action: "notify"
        message: |
          ✅ ルール整合性チェックが完了しました。
          レポート: {{patterns.rule_check_log}}
          エラーや警告がある場合は結果を確認し、必要に応じて 99_rule_maintenance.mdc の修正フローを実行してください。

  - trigger: "(ルール追加|ルール修正|ルール更新|ルール改定|ルール整備|ルール改修|ルール編集|ルール保守|ルール改善|rule maintenance|rule update|rule edit|rule add|rule improvement|ルールメンテ)"
    priority: high
    steps:
      - name: "start_message"
        action: "notify"
        message: "**ルールブラッシュアップを開始します。** 対象ルール・変更理由・paths整合について順にヒアリングします。"
      - name: "collect_info"
        action: "call 99_rule_maintenance.mdc => rule_maintenance_questions"
        message: "編集したい内容を具体的に入力してください。未決事項は保留メモとして記録します。"
      - name: "create_log"
        action: "create_markdown_file"
        path: "{{patterns.rule_maintenance_log}}"
        template_reference: "99_rule_maintenance.mdc => rule_maintenance_log_template"
        message: "Flow/agent_build ログを生成しました。検証・レビュー計画が揃っているか確認してください。"
      - name: "maybe_create_rule_skeleton"
        action: "conditional_step"
        condition: "{{operation}} == 'add'"
        true_action: "create_markdown_file: path='{{patterns.rule_skeleton_out}}' template_reference='99_rule_maintenance.mdc => rule_skeleton_template'"
        false_action: "notify: '編集モード: 既存ルールをブラッシュアップします（スケルトン生成は不要）'"
      - name: "post_creation_instruction"
        action: "notify"
        message: "**編集作業のお願い**\n- 追加の場合は {{patterns.rule_skeleton_out}} を開き、プロンプト/Phase/テンプレートなど全セクションをドメイン仕様で埋めてください。\n- 既存ルールの編集の場合は対象ファイルを更新し、変更点をログに追記してください。\n- Flow/agent_build タスクリストで、中身の埋め込みとレビュー完了にチェックを付けるまで忘れないでください。"
      - name: "completion_message"
        action: "notify"
        message: "**ルールブラッシュアップの記録が完了しました。**\n- ログ: {{patterns.rule_maintenance_log}}\n- タスクリスト: Flow/agent_build/{{meta.year_month}}/{{meta.today}}_agent_creation_tasklist.md を更新してください。"

  - trigger: "(パス更新|path更新|paths編集|パス構造変更|フォルダ構成調整|paths maintenance|path maintenance)"
    priority: high
    steps:
      - name: "start_path_review"
        action: "notify"
        message: "**パス定義の更新を開始します。** 変更したいフォルダ構造や root 設定を確認します。"
      - name: "collect_path_changes"
        action: "call 99_rule_maintenance.mdc => path_update_questions"
        message: "更新したいパス定義（{domain}_paths.mdc）と影響範囲を入力してください。"
      - name: "run_validation"
        action: "execute_shell"
        command: "python3 scripts/validate_rules.py"
        message: "最新パス定義でルールバリデーションを実行しています..."
      - name: "create_path_log"
        action: "create_markdown_file"
        path: "{{patterns.rule_check_log}}"
        template_reference: "99_rule_maintenance.mdc => path_update_report"
        message: "パス更新レポートを {{patterns.rule_check_log}} に記録しました。"
      - name: "notify_path_completion"
        action: "notify"
        message: "**パス定義の更新が完了しました。**\n- レポート: {{patterns.rule_check_log}}\n- 必要に応じて {domain}_paths.mdc と 00_master_rules.mdc の整合を再確認してください。"

# ==========================================================
# =========================
# Agent Derivation Instructions
# =========================
# ==========================================================

## LLM-Driven Agent Generation Guidelines

### 1. Template Variable Replacement
```yaml
Template     : 派生先エージェント名 (e.g., "BABOK", "Knowledge")
template         : ドメイン名 (e.g., "babok", "knowledge") 
{{specialized_rules}}: 01-89番台の専門ルール番号リスト
```

### 2. Rule Numbering Convention
- **00**: Master control rules (このファイル)
- **01-89**: Domain-specific specialized rules
- **97**: Flow to Stock rules (標準化済み)
- **98**: Flow assist / brainstorming
- **99**: Rule maintenance & system management

### 3. Standard Directory Structure
```
{agent_name}_agent/
├── Flow/           # 作業中ドラフト（日付階層で整理）
│   └── YYYYMM/
│       └── YYYYMMDD/
├── Stock/          # 確定版ドキュメント
├── Archived/       # アーカイブ
├── cursor_bank/    # ルールファイル群
└── scripts/        # 自動化スクリプト
```

### 4. Mandatory Files for Derived Agents
- `00_master_rules.mdc` (このテンプレートベース)
- `{domain}_paths.mdc` (パス定義)
- `97_flow_to_stock_rules.mdc` (Flow→Stock移動)
- `98_flow_assist.mdc` (対話支援)
- `99_rule_maintenance.mdc` (ルール保守)
- 生成済みエージェントでルール追加/編集/削除やフォルダ構成の調整を行う際は、00_master_rules.mdc と {domain}_paths.mdc の更新内容が漏れないよう 99_rule_maintenance.mdc のチェックリスト・ログテンプレートを必ず整備し、変更を追跡できる状態を維持する。
