---
description: Chrome拡張Manifest V3生成システム
globs:
alwaysApply: false
---
# ==========================================================
# 02_chrome_extension_manifest.mdc - Manifest V3設定
# ==========================================================

path_reference: "chrome_extension_paths.mdc"

# ======== プロンプト（目的と使い方） ========
prompt_purpose: |
  Chrome拡張開発者が Manifest V3 準拠の manifest.json を正確に生成し、権限・API・コンポーネント設定を適切に構成することで、Chrome Web Store 公開要件を満たします。

prompt_why_questions: |
  拡張機能の名称、バージョン、必要な権限、APIアクセス範囲、ホストパーミッションを収集することで、セキュリティ要件とユーザープライバシーを保護しつつ、必要な機能を実現できるmanifest設定を決定します。

prompt_why_templates: |
  Manifest V3の必須フィールド・推奨構造をテンプレート化することで、構文エラーや必須項目漏れを防ぎ、バリデーション通過率を向上させます。

prompt_principles: |
  - Manifest V3仕様に完全準拠
  - 最小権限原則（Principle of Least Privilege）を遵守
  - 権限要求の理由をユーザーに明示
  - 不足情報は「未記載」として明示
  - 出典URL・取得日時を記録

# ======== Manifest V3設定システム統合エージェント ========

system_capabilities:
  manifest_v3_compliance: "Manifest V3必須フィールド（manifest_version, name, version, description等）を自動検証し、Chrome Web Store要件に準拠した構成を生成"
  permissions_optimization: "最小権限原則に基づき、必要最低限の権限とホストパーミッションを設定し、ユーザー警告を最小化"
  action_configuration: "popup UI、アイコン、バッジ設定を統合的に管理し、ユーザー操作の起点を明確化"
  background_worker_setup: "Service Worker（Manifest V3）の設定を自動化し、永続的バックグラウンド処理を構成"
  content_scripts_management: "コンテンツスクリプトのマッチパターン、実行タイミング、CSSインジェクションを詳細設定"
  security_policy: "Content Security Policy (CSP) を設定し、リモートコード実行を禁止し、セキュリティ脅威を排除"

# ======== Phase 1: Manifest基本情報収集フェーズ ========

phase_1_description: |
  拡張機能の名称、バージョン、説明文、作者情報、ホームページURLなどの基本メタデータを収集します。
  Manifest V3必須項目（manifest_version: 3）を確認し、Chrome Web Store公開に必要な情報を整理します。
  アイコンファイルのパス・サイズ（16x16, 48x48, 128x128）を確認し、配置状況を記録します。

# ======== Phase 2: 権限・API設定フェーズ ========

phase_2_description: |
  必要な権限（permissions）、ホストパーミッション（host_permissions）、オプション権限（optional_permissions）を質問形式で収集します。
  Chrome Extensions APIの使用予定（storage, tabs, notifications, scripting等）を確認し、適切な権限を設定します。
  最小権限原則に基づき、不要な権限を除外し、ユーザープライバシーを保護します。

# ======== 統合オプション質問 ========

manifest_questions:
  - key: "extension_name"
    prompt: "拡張機能の名称を入力してください（Chrome Web Storeに表示される名前）："
    type: "text"
    required: true
    placeholder: "例: My Awesome Extension"

  - key: "extension_version"
    prompt: "バージョン番号を入力してください（セマンティックバージョニング推奨: X.Y.Z）："
    type: "text"
    required: true
    placeholder: "例: 1.0.0"

  - key: "extension_description"
    prompt: "拡張機能の説明文を入力してください（Chrome Web Storeに表示、132文字以内推奨）："
    type: "multiline"
    required: true
    placeholder: "例: Webページの特定要素を自動ハイライトし、閲覧体験を向上させます。"

  - key: "author_name"
    prompt: "作者名を入力してください："
    type: "text"
    required: false
    placeholder: "例: Your Name"

  - key: "homepage_url"
    prompt: "ホームページURL（任意）："
    type: "text"
    required: false
    placeholder: "例: https://example.com"

  - key: "permissions"
    prompt: "必要な権限を選択してください（カンマ区切り）:\n利用可能な権限:\n- activeTab: アクティブタブへのアクセス\n- storage: ローカルストレージ\n- tabs: タブ情報取得\n- notifications: 通知表示\n- scripting: スクリプト実行\n- contextMenus: 右クリックメニュー\n- cookies: Cookie操作\n- bookmarks: ブックマーク操作\n- history: 履歴操作"
    type: "text"
    required: true
    placeholder: "例: activeTab,storage,scripting"

  - key: "host_permissions"
    prompt: "ホストパーミッション（アクセス対象URL）を入力してください（カンマ区切り）:\n例: <all_urls>, https://*.example.com/*"
    type: "text"
    required: false
    placeholder: "例: <all_urls>"

  - key: "optional_permissions"
    prompt: "オプション権限（ユーザーが後から許可する権限）を入力してください（カンマ区切り、任意）："
    type: "text"
    required: false
    placeholder: "例: history,bookmarks"

  - key: "has_popup"
    prompt: "Popup UI（ツールバーアイコンクリック時の表示）を使用しますか？ (yes/no)"
    type: "text"
    required: true
    placeholder: "yes"

  - key: "popup_html_path"
    prompt: "Popup HTMLファイルのパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/html/popup.html"

  - key: "has_background"
    prompt: "Background Service Workerを使用しますか？ (yes/no)"
    type: "text"
    required: true
    placeholder: "yes"

  - key: "background_script_path"
    prompt: "Background Service WorkerのJSファイルパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/js/background.js"

  - key: "has_content_scripts"
    prompt: "Content Scriptsを使用しますか？ (yes/no)"
    type: "text"
    required: true
    placeholder: "yes"

  - key: "content_script_matches"
    prompt: "Content Scriptsを実行するURLパターンを入力してください（カンマ区切り）："
    type: "text"
    required: false
    placeholder: "例: <all_urls>, https://*.example.com/*"

  - key: "content_script_js"
    prompt: "Content ScriptのJSファイルパスを入力してください（カンマ区切り）："
    type: "text"
    required: false
    placeholder: "例: src/js/content.js"

  - key: "content_script_css"
    prompt: "Content ScriptのCSSファイルパスを入力してください（カンマ区切り、任意）："
    type: "text"
    required: false
    placeholder: "例: src/css/content.css"

  - key: "has_options_page"
    prompt: "Options Page（設定画面）を使用しますか？ (yes/no)"
    type: "text"
    required: false
    placeholder: "no"

  - key: "options_page_path"
    prompt: "Options PageのHTMLファイルパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/html/options.html"

  - key: "icon_16_path"
    prompt: "16x16アイコンファイルパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/images/icon16.png"

  - key: "icon_48_path"
    prompt: "48x48アイコンファイルパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/images/icon48.png"

  - key: "icon_128_path"
    prompt: "128x128アイコンファイルパスを入力してください："
    type: "text"
    required: false
    placeholder: "例: src/images/icon128.png"

# ======== Manifest生成プロセス ========

manifest_generation_steps:
  1_basic_metadata:
    name: "基本メタデータ設定"
    phases:
      - "manifest_version: 3 を固定値として設定"
      - "name, version, description を質問回答から設定"
      - "author（任意）、homepage_url（任意）を設定"
      - "icons フィールドに icon_16_path, icon_48_path, icon_128_path を配置"
    quality_standards:
      - "name は45文字以内（Chrome Web Store推奨）"
      - "description は132文字以内（Chrome Web Store推奨）"
      - "version はセマンティックバージョニング（X.Y.Z）形式"

  2_permissions_setup:
    name: "権限設定"
    phases:
      - "permissions フィールドに質問回答から権限を配列として設定"
      - "host_permissions フィールドにホストパーミッションを配列として設定"
      - "optional_permissions フィールドにオプション権限を配列として設定（任意）"
      - "最小権限原則を確認し、不要な権限を除外"
    integration_points:
      - "activeTabとhost_permissionsの競合を確認"
      - "Manifest V2からの移行時は permissions から host_permissions への分離を実施"

  3_action_configuration:
    name: "Action（Popup）設定"
    phases:
      - "has_popup が 'yes' の場合、action フィールドを生成"
      - "default_popup に popup_html_path を設定"
      - "default_icon に各サイズのアイコンパスを設定"
      - "default_title にツールチップテキストを設定（オプション）"
    automation_features:
      - "popup.html が存在しない場合は警告を表示"

  4_background_worker_setup:
    name: "Background Service Worker設定"
    phases:
      - "has_background が 'yes' の場合、background フィールドを生成"
      - "service_worker に background_script_path を設定（Manifest V3はservice_worker必須）"
      - "type: 'module' の設定（ES Modules使用時）をオプションで追加"
    quality_standards:
      - "Manifest V3ではbackground.scriptsではなくbackground.service_workerを使用"

  5_content_scripts_setup:
    name: "Content Scripts設定"
    phases:
      - "has_content_scripts が 'yes' の場合、content_scripts フィールドを生成"
      - "matches に content_script_matches を配列として設定"
      - "js に content_script_js を配列として設定"
      - "css に content_script_css を配列として設定（任意）"
      - "run_at に 'document_idle'（デフォルト）または指定値を設定"
    integration_points:
      - "all_frames, match_about_blank などの詳細設定は必要に応じて追加"

  6_options_page_setup:
    name: "Options Page設定"
    phases:
      - "has_options_page が 'yes' の場合、options_page フィールドを生成"
      - "options_page_path を設定"
    automation_features:
      - "options_ui を使用する場合は open_in_tab 設定を追加"

# ======== Manifestワークフロー ========

manifest_workflow:
  phase_1:
    - name: "基本情報収集"
      action: "call 02_chrome_extension_manifest.mdc => manifest_questions"
      description: "Manifest必須項目と権限設定を質問形式で収集"
      mandatory: true

  phase_2:
    - name: "manifest.json生成"
      action: "create_file"
      description: "収集した情報をもとにManifest V3準拠のJSONを生成"
      mandatory: true

    - name: "ドラフト保存"
      action: "create_markdown_file"
      description: "Flow側にmanifest設計メモを保存"
      mandatory: true

# ======== テンプレート ========

manifest_v3_template: |
  {
    "manifest_version": 3,
    "name": "{{extension_name}}",
    "version": "{{extension_version}}",
    "description": "{{extension_description}}",
    {{#if author_name}}
    "author": "{{author_name}}",
    {{/if}}
    {{#if homepage_url}}
    "homepage_url": "{{homepage_url}}",
    {{/if}}
    "icons": {
      "16": "{{icon_16_path}}",
      "48": "{{icon_48_path}}",
      "128": "{{icon_128_path}}"
    },
    {{#if permissions}}
    "permissions": [{{permissions}}],
    {{/if}}
    {{#if host_permissions}}
    "host_permissions": [{{host_permissions}}],
    {{/if}}
    {{#if optional_permissions}}
    "optional_permissions": [{{optional_permissions}}],
    {{/if}}
    {{#if has_popup}}
    "action": {
      "default_popup": "{{popup_html_path}}",
      "default_icon": {
        "16": "{{icon_16_path}}",
        "48": "{{icon_48_path}}",
        "128": "{{icon_128_path}}"
      }
    },
    {{/if}}
    {{#if has_background}}
    "background": {
      "service_worker": "{{background_script_path}}"
    },
    {{/if}}
    {{#if has_content_scripts}}
    "content_scripts": [
      {
        "matches": [{{content_script_matches}}],
        "js": [{{content_script_js}}]{{#if content_script_css}},
        "css": [{{content_script_css}}]{{/if}}
      }
    ],
    {{/if}}
    {{#if has_options_page}}
    "options_page": "{{options_page_path}}",
    {{/if}}
    "content_security_policy": {
      "extension_pages": "script-src 'self'; object-src 'self'"
    }
  }

manifest_design_memo_template: |
  # Manifest V3 設計メモ - {{meta.timestamp}}

  ## 基本情報
  - **拡張機能名**: {{extension_name}}
  - **バージョン**: {{extension_version}}
  - **説明**: {{extension_description}}
  - **作者**: {{author_name}}
  - **ホームページ**: {{homepage_url}}

  ## 権限設定
  ### 必須権限（permissions）
  {{permissions}}

  ### ホストパーミッション（host_permissions）
  {{host_permissions}}

  ### オプション権限（optional_permissions）
  {{#if optional_permissions}}{{optional_permissions}}{{else}}未設定{{/if}}

  ## コンポーネント構成
  - **Popup UI**: {{has_popup}}
  - **Background Service Worker**: {{has_background}}
  - **Content Scripts**: {{has_content_scripts}}
  - **Options Page**: {{has_options_page}}

  ## アイコン
  - 16x16: {{icon_16_path}}
  - 48x48: {{icon_48_path}}
  - 128x128: {{icon_128_path}}

  ## Content Scripts設定
  - **Matches**: {{content_script_matches}}
  - **JS**: {{content_script_js}}
  - **CSS**: {{content_script_css}}

  ## セキュリティポリシー
  - Content Security Policy (CSP): script-src 'self'; object-src 'self'
  - リモートコード実行: 禁止（Manifest V3準拠）

  ## Manifest V3 必須項目チェック
  - [x] manifest_version: 3
  - [x] name
  - [x] version
  - [x] description
  - [x] icons

  ## 次のステップ
  1. manifest.jsonをルートディレクトリに配置
  2. アイコンファイルを指定パスに配置
  3. Popup/Background/Content Scriptの実装開始
  4. バリデーションチェック実施

  ---
  **保存先**: Flow/{{meta.year_month}}/{{meta.today}}/manifest_design_{{meta.today}}.md
  **参照**: https://developer.chrome.com/docs/extensions/mv3/manifest/

# ======== エラーハンドリング ========

error_handling:
  missing_required_field:
    message: "必須フィールド（name, version, description）が未入力です。"
    recovery_actions:
      - "ユーザーに再入力を促す"
      - "デフォルト値を提示（例: version: '1.0.0'）"

  invalid_version_format:
    message: "バージョン番号がセマンティックバージョニング形式（X.Y.Z）に準拠していません。"
    recovery_actions:
      - "正しい形式の例を提示（例: 1.0.0, 2.1.3）"
      - "自動補正を提案"

  excessive_permissions:
    message: "不要な権限が設定されている可能性があります。最小権限原則に基づき見直してください。"
    recovery_actions:
      - "各権限の必要性を確認"
      - "推奨権限セットを提示"

# ======== 設定 ========

manifest_settings:
  default_manifest_version: 3
  max_name_length: 45
  max_description_length: 132
  recommended_icon_sizes: [16, 48, 128]
  csp_default: "script-src 'self'; object-src 'self'"

# ======== 統合ポイント ========

integration_points:
  validation:
    trigger: "manifest.json生成後"
    action: "call 06_chrome_extension_validation.mdc"

  popup_implementation:
    trigger: "has_popup が true の場合"
    action: "call 03_chrome_extension_popup.mdc"

  background_implementation:
    trigger: "has_background が true の場合"
    action: "call 04_chrome_extension_background.mdc"

  content_implementation:
    trigger: "has_content_scripts が true の場合"
    action: "call 05_chrome_extension_content.mdc"

# ======== 品質保証 ========

quality_assurance:
  mandatory_checks:
    - "manifest_version が 3 であること"
    - "name, version, description が設定されていること"
    - "permissions が最小権限原則に準拠していること"
    - "Service Worker が background.service_worker として設定されていること（Manifest V3）"
    - "アイコンサイズが推奨値（16, 48, 128）を含むこと"

# ======== 成功メトリクス ========

success_metrics:
  - "manifest.jsonバリデーションエラー = 0"
  - "Chrome Web Store必須項目充足率 = 100%"
  - "権限警告最小化率 > 80%"
  - "CSP準拠率 = 100%"
