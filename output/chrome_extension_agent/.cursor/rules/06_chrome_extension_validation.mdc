---
description: Chrome拡張バリデーション・品質チェックシステム
globs:
alwaysApply: false
---
# ==========================================================
# 06_chrome_extension_validation.mdc - バリデーションチェック
# ==========================================================

path_reference: "chrome_extension_paths.mdc"

# ======== プロンプト（目的と使い方） ========
prompt_purpose: |
  Chrome拡張開発者がManifest V3準拠、構文正確性、セキュリティ要件を自動検証し、Chrome Web Store公開前にエラーを検出・修正することで、リジェクトリスクを最小化します。

prompt_why_questions: |
  検証対象ファイル（manifest.json, popup.html, background.js等）、検証レベル（基本/詳細）、修正自動化の希望を収集することで、効率的なバリデーションワークフローを構築します。

prompt_why_templates: |
  バリデーション結果レポート、エラー修正チェックリスト、再検証ログをテンプレート化することで、エラー修正の抜け漏れを防ぎ、品質保証プロセスを標準化します。

prompt_principles: |
  - Manifest V3準拠を最優先で検証
  - エラーは具体的な修正方法とともに提示
  - 警告とエラーを明確に区別
  - バリデーション結果は必ずFlow側にログ保存
  - 通過するまで繰り返し実行可能な仕組みを提供

# ======== Chrome拡張バリデーションシステム統合エージェント ========

system_capabilities:
  manifest_validation: "manifest.jsonの必須フィールド、構文正確性、Manifest V3仕様準拠を自動検証し、Chrome Web Store要件との差分を検出"
  permissions_audit: "権限設定（permissions, host_permissions）が最小権限原則に準拠しているかを監査し、不要な権限を警告"
  security_scan: "Content Security Policy (CSP)、リモートコード実行リスク、XSS脆弱性を検出し、セキュリティ脅威を排除"
  file_integrity_check: "popup.html, background.js, content.js等のファイル存在確認と構文チェックを実施"
  icon_validation: "アイコンファイル（16x16, 48x48, 128x128）の存在・サイズ・フォーマットを検証"
  automated_fix_suggestion: "検出されたエラーに対して具体的な修正コードと手順を提示し、自動修正オプションを提供"

# ======== Phase 1: バリデーション準備フェーズ ========

phase_1_description: |
  バリデーション対象ファイルのパス、検証レベル（基本/詳細）、自動修正の希望を質問形式で収集します。
  manifest.jsonの存在を確認し、パース可能かを事前チェックします。
  前回のバリデーション結果がある場合は、差分確認モードで実行するかを確認します。

# ======== Phase 2: バリデーション実行フェーズ ========

phase_2_description: |
  Manifest V3必須項目検証、権限監査、セキュリティスキャン、ファイル整合性チェック、アイコン検証を順次実行します。
  各検証項目でエラー・警告を収集し、優先度（Critical/High/Medium/Low）を付与します。
  バリデーション結果をFlow側にログ保存し、エラーがある場合は修正提案を提示します。
  エラーゼロになるまで再検証を促し、通過後にStock側への移行を提案します。

# ======== 統合オプション質問 ========

validation_questions:
  - key: "manifest_path"
    prompt: "manifest.jsonのパスを入力してください："
    type: "text"
    required: true
    placeholder: "例: /path/to/chrome_extension_agent/manifest.json"

  - key: "project_root"
    prompt: "プロジェクトルートディレクトリを入力してください："
    type: "text"
    required: true
    placeholder: "例: /home/user/agent_template_public/output/chrome_extension_agent"

  - key: "validation_level"
    prompt: "検証レベルを選択してください:\n- basic: 基本検証（必須項目・構文のみ）\n- detailed: 詳細検証（セキュリティ・最適化含む）"
    type: "text"
    required: true
    placeholder: "例: detailed"

  - key: "auto_fix"
    prompt: "自動修正を有効にしますか？ (yes/no)\n※自動修正は一部の軽微なエラーのみ対応します"
    type: "text"
    required: false
    placeholder: "no"

  - key: "check_icons"
    prompt: "アイコンファイルの検証を実施しますか？ (yes/no)"
    type: "text"
    required: false
    placeholder: "yes"

  - key: "check_scripts"
    prompt: "JavaScriptファイルの構文チェックを実施しますか？ (yes/no)"
    type: "text"
    required: false
    placeholder: "yes"

  - key: "previous_validation_log"
    prompt: "前回のバリデーションログパスを入力してください（差分確認モード、任意）："
    type: "text"
    required: false
    placeholder: "例: Flow/202511/20251102/validation_log_20251102.md"

# ======== バリデーションプロセス ========

validation_steps:
  1_manifest_validation:
    name: "Manifest V3必須項目検証"
    phases:
      - "manifest.jsonの存在確認とJSON構文パース"
      - "manifest_version が 3 であることを確認"
      - "必須フィールド（name, version, description, icons）の存在確認"
      - "permissions と host_permissions の分離確認（Manifest V2から移行時の典型的エラー）"
      - "Service Worker（background.service_worker）の設定確認（Manifest V3必須）"
    quality_standards:
      - "manifest_version: 3 が設定されていること"
      - "name, version, description が空でないこと"
      - "icons に少なくとも1つのサイズが設定されていること"

  2_permissions_audit:
    name: "権限監査"
    phases:
      - "permissions フィールドの各権限が実際に使用されているか確認"
      - "host_permissions が <all_urls> の場合、警告を表示（最小権限原則違反の可能性）"
      - "optional_permissions が適切に設定されているか確認"
      - "不要な権限候補をリストアップ"
    integration_points:
      - "background.jsやcontent.jsを解析し、使用されていないAPIを特定"

  3_security_scan:
    name: "セキュリティスキャン"
    phases:
      - "Content Security Policy (CSP) の設定確認"
      - "manifest.json内にリモートコード実行リスクがないか確認（Manifest V3では禁止）"
      - "XSS脆弱性リスク（innerHTML使用箇所）の検出"
      - "eval() 使用の検出と警告"
    automation_features:
      - "CSPが未設定の場合、デフォルトCSPを自動追加提案"

  4_file_integrity_check:
    name: "ファイル整合性チェック"
    phases:
      - "manifest.jsonで参照されている全ファイル（popup.html, background.js, content.js等）の存在確認"
      - "JavaScriptファイルの構文チェック（check_scripts が yes の場合）"
      - "HTMLファイルの基本構造確認"
    quality_standards:
      - "manifest.jsonで参照されている全ファイルが実在すること"
      - "JavaScriptに構文エラーがないこと"

  5_icon_validation:
    name: "アイコン検証"
    phases:
      - "icons フィールドで指定されたアイコンファイルの存在確認（check_icons が yes の場合）"
      - "推奨サイズ（16x16, 48x48, 128x128）がすべて設定されているか確認"
      - "画像フォーマット（PNG推奨）の確認"
    automation_features:
      - "不足しているアイコンサイズを警告"

  6_error_reporting:
    name: "エラーレポート生成"
    phases:
      - "Critical/High/Medium/Lowの優先度別にエラー・警告を分類"
      - "各エラーに対して具体的な修正方法を提示"
      - "バリデーション結果をFlow/{{meta.year_month}}/{{meta.today}}/validation_log_{{meta.today}}.md に保存"
      - "エラーがある場合は再検証を促すメッセージを表示"
    quality_standards:
      - "Criticalエラーがゼロになるまで再検証必須"

# ======== バリデーションワークフロー ========

validation_workflow:
  phase_1:
    - name: "バリデーション設定収集"
      action: "call 06_chrome_extension_validation.mdc => validation_questions"
      description: "検証対象ファイル、検証レベル、自動修正設定を収集"
      mandatory: true

  phase_2:
    - name: "Manifest検証実行"
      action: "execute_validation"
      description: "Manifest V3必須項目、権限、セキュリティ、ファイル整合性を検証"
      mandatory: true

    - name: "エラーレポート生成"
      action: "create_markdown_file"
      description: "バリデーション結果をFlow側にログ保存"
      mandatory: true

    - name: "修正提案提示"
      action: "message"
      description: "検出されたエラーに対して具体的な修正方法を提示"
      mandatory: true

  phase_3:
    - name: "再検証ループ"
      action: "conditional_step"
      description: "エラーがある場合は修正後に再検証を実行、エラーゼロになるまで繰り返し"
      mandatory: true

# ======== テンプレート ========

validation_report_template: |
  # Chrome拡張バリデーションレポート - {{meta.timestamp}}

  ## 検証概要
  - **プロジェクトルート**: {{project_root}}
  - **manifest.jsonパス**: {{manifest_path}}
  - **検証レベル**: {{validation_level}}
  - **自動修正**: {{auto_fix}}

  ## 検証結果サマリー
  - **Total Errors**: {{total_errors}}
  - **Total Warnings**: {{total_warnings}}
  - **Validation Status**: {{#if total_errors > 0}}FAILED❌{{else}}PASSED✅{{/if}}

  ---

  ## Criticalエラー（即修正必須）
  {{#each critical_errors}}
  ### {{@index + 1}}. {{this.title}}
  - **詳細**: {{this.description}}
  - **影響**: {{this.impact}}
  - **修正方法**:
    ```{{this.fix_code_language}}
    {{this.fix_code}}
    ```
  - **参照**: {{this.reference_url}}
  {{/each}}

  {{#if critical_errors.length == 0}}
  ✅ Criticalエラーなし
  {{/if}}

  ---

  ## Highエラー（優先修正推奨）
  {{#each high_errors}}
  ### {{@index + 1}}. {{this.title}}
  - **詳細**: {{this.description}}
  - **修正方法**: {{this.fix_description}}
  {{/each}}

  {{#if high_errors.length == 0}}
  ✅ Highエラーなし
  {{/if}}

  ---

  ## 警告（最適化推奨）
  {{#each warnings}}
  - {{this.message}}
  {{/each}}

  {{#if warnings.length == 0}}
  ✅ 警告なし
  {{/if}}

  ---

  ## 次のステップ
  {{#if total_errors > 0}}
  1. 上記のCriticalエラーを優先的に修正してください
  2. 修正後、再度バリデーションを実行してください
  3. すべてのエラーが解消されるまで繰り返してください
  {{else}}
  ✅ **バリデーション通過！**
  次のステップ:
  - Chrome開発者モードで拡張機能を読み込んでテスト
  - `07_chrome_extension_testing` ルールでテスト実施
  - パッケージング準備（build/）
  {{/if}}

  ---
  **保存先**: Flow/{{meta.year_month}}/{{meta.today}}/validation_log_{{meta.today}}.md
  **再検証コマンド**: 「Chrome拡張バリデーション」トリガーを再実行

error_fix_checklist_template: |
  # バリデーションエラー修正チェックリスト - {{meta.timestamp}}

  ## Criticalエラー修正
  {{#each critical_errors}}
  - [ ] {{this.title}} - {{this.fix_description}}
  {{/each}}

  ## Highエラー修正
  {{#each high_errors}}
  - [ ] {{this.title}} - {{this.fix_description}}
  {{/each}}

  ## 警告対応
  {{#each warnings}}
  - [ ] {{this.message}}
  {{/each}}

  ## 修正完了後の確認事項
  - [ ] manifest.jsonの構文エラーなし
  - [ ] 全参照ファイルが存在
  - [ ] アイコンサイズ準拠
  - [ ] 権限最小化確認
  - [ ] CSP設定確認
  - [ ] 再バリデーション実行
  - [ ] エラーゼロ達成

  ---
  **次回バリデーション**: Flow/{{meta.year_month}}/{{meta.today}}/validation_log_{{meta.today}}_recheck.md

# ======== エラーハンドリング ========

error_handling:
  manifest_not_found:
    message: "manifest.jsonが指定パスに存在しません。パスを確認してください。"
    recovery_actions:
      - "プロジェクトルートディレクトリを確認"
      - "manifest.jsonを作成する場合は 02_chrome_extension_manifest ルールを実行"

  manifest_parse_error:
    message: "manifest.jsonのJSON構文にエラーがあります。パースに失敗しました。"
    recovery_actions:
      - "JSONLintなどでmanifest.jsonを検証"
      - "カンマ・括弧の不一致を確認"
      - "自動修正ツールの使用を提案"

  critical_errors_present:
    message: "Criticalエラーが検出されました。これらを修正しないとChrome拡張として動作しません。"
    recovery_actions:
      - "エラーレポートの修正方法に従って対応"
      - "修正後に再バリデーション実行"
      - "通過するまで繰り返し"

# ======== 設定 ========

validation_settings:
  max_validation_iterations: 10
  auto_fix_enabled_errors: ["missing_csp", "invalid_version_format"]
  critical_error_types: ["manifest_version_not_3", "missing_required_field", "service_worker_missing"]
  warning_threshold: 5

# ======== 統合ポイント ========

integration_points:
  post_validation_testing:
    trigger: "バリデーション通過後"
    action: "call 07_chrome_extension_testing.mdc"

  manifest_fix:
    trigger: "Manifestエラー検出時"
    action: "call 02_chrome_extension_manifest.mdc"

  re_validation_loop:
    trigger: "エラー修正後"
    action: "call 06_chrome_extension_validation.mdc（再実行）"

# ======== 品質保証 ========

quality_assurance:
  mandatory_checks:
    - "manifest_version: 3 が設定されていること"
    - "必須フィールド（name, version, description, icons）がすべて存在すること"
    - "Service Workerが background.service_worker として設定されていること"
    - "CSPが設定されていること"
    - "manifest.jsonで参照されている全ファイルが存在すること"

# ======== 成功メトリクス ========

success_metrics:
  - "Criticalエラー検出率 = 100%"
  - "バリデーション実行時間 < 10秒"
  - "エラー修正後の再検証成功率 > 90%"
  - "Chrome Web Store要件準拠率 = 100%"
